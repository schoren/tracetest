"use strict";(self.webpackChunktracetest_docs=self.webpackChunktracetest_docs||[]).push([[6939],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var s=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,s,a=function(e,t){if(null==e)return{};var n,s,a={},r=Object.keys(e);for(s=0;s<r.length;s++)n=r[s],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(s=0;s<r.length;s++)n=r[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=s.createContext({}),l=function(e){var t=s.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=l(e.components);return s.createElement(p.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},d=s.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,p=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),m=l(n),d=a,h=m["".concat(p,".").concat(d)]||m[d]||u[d]||r;return n?s.createElement(h,o(o({ref:t},c),{},{components:n})):s.createElement(h,o({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=d;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i[m]="string"==typeof e?e:a,o[1]=i;for(var l=2;l<r;l++)o[l]=n[l];return s.createElement.apply(null,o)}return s.createElement.apply(null,n)}d.displayName="MDXCreateElement"},76864:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>l});var s=n(87462),a=(n(67294),n(3905));const r={},o="Pokeshop API - Import Pokemon",i={unversionedId:"live-examples/pokeshop/use-cases/import-pokemon",id:"live-examples/pokeshop/use-cases/import-pokemon",title:"Pokeshop API - Import Pokemon",description:"This use case showcases a more complex scenario involving an async process. Usually, when working with microservices, there are use cases where some of the processing needs to happen asynchronously, for example, when triggering a user notification, generating reports or processing a payment order. With this endpoint, we provide an example of how users can implement trace-based testing for such scenarios.",source:"@site/docs/live-examples/pokeshop/use-cases/import-pokemon.md",sourceDirName:"live-examples/pokeshop/use-cases",slug:"/live-examples/pokeshop/use-cases/import-pokemon",permalink:"/live-examples/pokeshop/use-cases/import-pokemon",draft:!1,editUrl:"https://github.com/kubeshop/tracetest/blob/main/docs/docs/live-examples/pokeshop/use-cases/import-pokemon.md",tags:[],version:"current",frontMatter:{},sidebar:"liveExamplesSidebar",previous:{title:"Pokeshop API - Get Pokemon by ID",permalink:"/live-examples/pokeshop/use-cases/get-pokemon-by-id"},next:{title:"Pokeshop API - Import Pokemon from Stream",permalink:"/live-examples/pokeshop/use-cases/import-pokemon-from-stream"}},p={},l=[{value:"Building a Test for This Scenario",id:"building-a-test-for-this-scenario",level:2},{value:"Traces",id:"traces",level:3},{value:"Assertions",id:"assertions",level:3},{value:"Test Definition",id:"test-definition",level:3}],c={toc:l},m="wrapper";function u(e){let{components:t,...r}=e;return(0,a.kt)(m,(0,s.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"pokeshop-api---import-pokemon"},"Pokeshop API - Import Pokemon"),(0,a.kt)("p",null,"This use case showcases a more complex scenario involving an async process. Usually, when working with microservices, there are use cases where some of the processing needs to happen asynchronously, for example, when triggering a user notification, generating reports or processing a payment order. With this endpoint, we provide an example of how users can implement trace-based testing for such scenarios."),(0,a.kt)("p",null,"Here the process is split into two phases: "),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"An API call that enqueues an import request to a queue.")),(0,a.kt)("mermaid",{value:'sequenceDiagram\n    participant Endpoint as POST /pokemon\n    participant API as API\n    participant Queue as RabbitMQ\n    \n    Endpoint->>API: request\n\n    alt request is invalid\n        API--\x3e>Endpoint: 400 Bad Request <br> <List of errors>\n    end\n\n    API->>Queue: enqueue "import" message\n    Queue--\x3e>API: message queued\n\n    API--\x3e>Endpoint: 201 Created'}),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"A Worker that dequeues messages and completes the async process.")),(0,a.kt)("mermaid",{value:'sequenceDiagram\n    participant Queue as RabbitMQ\n    participant Worker as Queue Worker\n    participant ExternalAPI as PokeAPI\n    participant Database as Postgres\n    \n    Queue->>Worker: dequeue "import" message\n\n    Worker->>ExternalAPI: get pokemon info\n    ExternalAPI--\x3e>Worker: pokemon info\n\n    Worker->>Database: save pokemon\n    Database--\x3e>Worker: pokemon saved\n  \n    alt if successful\n      Worker--\x3e>Queue: ack <br> queue can delete message\n    else is failed\n      Worker--\x3e>Queue: nack <br> queue keep message for retries\n    end'}),(0,a.kt)("p",null,"You can trigger this use case by calling the endpoint ",(0,a.kt)("inlineCode",{parentName:"p"},"POST /pokemon/import"),", with the following request body:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "id":  52\n}\n')),(0,a.kt)("p",null,"It should return the following payload:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "id":  52\n}\n')),(0,a.kt)("h2",{id:"building-a-test-for-this-scenario"},"Building a Test for This Scenario"),(0,a.kt)("p",null,"Using Tracetest, we can ",(0,a.kt)("a",{parentName:"p",href:"/web-ui/creating-tests"},"create a test")," that will execute an API call on ",(0,a.kt)("inlineCode",{parentName:"p"},"POST /pokemon/import")," and validate the following properties:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The API should enqueue an import task and return HTTP 200 OK."),(0,a.kt)("li",{parentName:"ul"},"The worker should dequeue the import task."),(0,a.kt)("li",{parentName:"ul"},"PokeAPI should return a valid response."),(0,a.kt)("li",{parentName:"ul"},"The database should respond with low latency (< 200ms).")),(0,a.kt)("h3",{id:"traces"},"Traces"),(0,a.kt)("p",null,"Running these tests for the first time will create an Observability trace like the image below, where you can see spans for the API call, the queue messaging, the PokeAPI (external API) call and database calls. One interesting thing about this trace is that ",(0,a.kt)("strong",{parentName:"p"},"you can observe the entire use case, end to end"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(45146).Z,width:"1326",height:"1460"})),(0,a.kt)("h3",{id:"assertions"},"Assertions"),(0,a.kt)("p",null,"With this trace, we can build ",(0,a.kt)("a",{parentName:"p",href:"/concepts/assertions"},"assertions")," on Tracetest and validate the API and Worker behaviors:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"The API should enqueue an import task and return HTTP 200 OK:"),"\n",(0,a.kt)("img",{src:n(52411).Z,width:"2976",height:"762"}),"\n",(0,a.kt)("img",{src:n(83736).Z,width:"2982",height:"796"}))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"The worker should dequeue the import task:"),"\n",(0,a.kt)("img",{src:n(963).Z,width:"2958",height:"882"}))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"PokeAPI should return a valid response:"),"\n",(0,a.kt)("img",{src:n(84301).Z,width:"2976",height:"828"}))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"The database should respond with low latency (< 200ms):"),"\n",(0,a.kt)("img",{src:n(35714).Z,width:"2972",height:"790"})))),(0,a.kt)("p",null,"Now you can validate this entire use case."),(0,a.kt)("h3",{id:"test-definition"},"Test Definition"),(0,a.kt)("p",null,"If you want to replicate this entire test on Tracetest, you can replicate these steps on our Web UI or using our CLI, saving the following test definition as the file ",(0,a.kt)("inlineCode",{parentName:"p"},"test-definition.yml")," and later running:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"tracetest run test -f test-definition.yml\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'type: Test\nspec:\n  name: Pokeshop - Import\n  description: Import a Pokemon\n  trigger:\n    type: http\n    httpRequest:\n      url: http://demo-pokemon-api.demo/pokemon/import\n      method: POST\n      headers:\n      - key: Content-Type\n        value: application/json\n      body: \'{"id":52}\'\n  specs:\n  - selector: span[tracetest.span.type="messaging" name="queue.synchronizePokemon\n      send" messaging.system="rabbitmq" messaging.destination="queue.synchronizePokemon"]\n    assertions:\n    - attr:messaging.payload = \'{"id":52}\'\n  - selector: span[tracetest.span.type="http" name="POST /pokemon/import" http.method="POST"]\n    assertions:\n    - attr:http.status_code = 200\n    - attr:http.response.body = \'{"id":52}\'\n  - selector: span[tracetest.span.type="messaging" name="queue.synchronizePokemon\n      receive" messaging.system="rabbitmq" messaging.destination="queue.synchronizePokemon"]\n    assertions:\n    - attr:name = "queue.synchronizePokemon receive"\n  - selector: span[tracetest.span.type="http" name="HTTP GET pokeapi.pokemon" http.method="GET"]\n    assertions:\n    - attr:http.response.body  =  \'{"name":"meowth"}\'\n    - attr:http.status_code  =  200\n  - selector: span[tracetest.span.type="database"]\n    assertions:\n    - attr:tracetest.span.duration <= 200ms\n\n')))}u.isMDXComponent=!0},83736:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/import-pokemon-api-test-spec-9d675cd08e1e5adb7ee0f4db28fd604d.png"},35714:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/import-pokemon-db-latency-test-spec-e52791c95be226fa0e1402c4486be532.png"},963:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/import-pokemon-message-dequeue-test-spec-f8a3e985984c2d532dbf86023eef120d.png"},52411:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/import-pokemon-message-enqueue-test-spec-32297657baf2bd7c228969234177407f.png"},84301:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/import-pokemon-pokeapi-call-test-spec-383afa38e11a20f031a47330f9a8ce38.png"},45146:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/import-pokemon-trace-f9d7ab3a3bbcba45ff785aab36fab085.png"}}]);